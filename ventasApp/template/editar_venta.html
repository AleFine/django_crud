{% extends 'index.html' %}

{% block content %}
<div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
    <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <h2 class="text-title-md2 font-bold text-black dark:text-white">
            Editar Venta
        </h2>
        <nav>
            <ol class="flex items-center gap-2">
                <li class="font-medium text-primary"><a href="{% url 'listar_ventas' %}">Volver</a></li>
            </ol>
        </nav>
    </div>

    <div class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
        <div class="border-b border-stroke px-6.5 py-4 dark:border-strokedark">
            <h3 class="font-medium text-black dark:text-white">Editar Venta</h3>
        </div>
        <div class="flex flex-col gap-5.5 p-6.5">
            {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            
            <form method="POST" id="ventaForm">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="{{ venta_form.cliente.id_for_label }}" class="block text-sm font-medium text-gray-700">Cliente</label>
                    {{ venta_form.cliente }}
                </div>
                
                <div class="mb-4">
                    <label for="{{ venta_form.fecha_venta.id_for_label }}" class="block text-sm font-medium text-gray-700">Fecha de Venta</label>
                    {{ venta_form.fecha_venta }}
                </div>
                
                <div class="mb-4">
                    <label for="{{ venta_form.documento.id_for_label }}" class="block text-sm font-medium text-gray-700">Documento</label>
                    {{ venta_form.documento }}
                </div>
                
                <h2 class="text-xl font-bold mb-2">Detalles de la Venta</h2>
                
                <div class="overflow-x-auto">
                    <table id="detallesTable" class="w-full mb-4 border-collapse">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border p-2 text-center">Producto</th>
                                <th class="border p-2 text-center">Cantidad</th>
                                <th class="border p-2 text-center">Precio</th>
                                <th class="border p-2 text-center">Subtotal</th>
                                <th class="border p-2 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="detallesBody">
                            {% for detalle in venta.detalleventa_set.all %}
                            <tr>
                                <td class="border p-2 text-center">
                                    <select name="id_producto[]" class="w-full">
                                        <option value="">Seleccione un producto</option>
                                        {% for producto in productos %}
                                        <option value="{{ producto.id }}" data-precio="{{ producto.precio }}" {% if producto.id == detalle.producto.id %}selected{% endif %}>{{ producto.descripcion }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="border p-2 text-center">
                                    <input type="number" name="cantidad[]" value="{{ detalle.cantidad }}" min="1" class="text-center w-full">
                                </td>
                                <td class="border p-2 text-center precio">{{ detalle.precio }}</td>
                                <td class="border p-2 text-center subtotal">{{ detalle.precio|floatformat:2 }}</td>
                                <td class="border p-2 text-center">
                                    <button type="button" class="eliminarFila bg-red-500 text-black dark:text-white px-2 py-1 rounded">Eliminar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <button type="button" id="agregarProducto" class="bg-blue-500 text-black dark:text-white px-4 py-2 rounded">Agregar Producto</button>
                
                <div class="mt-4">
                    <p>Total: <span id="totalVenta">{{ venta.total|floatformat:2 }}</span></p>
                </div>
                
                <input type="hidden" name="total" id="totalInput" value="{{ venta.total|floatformat:2 }}">
                
                <button type="submit" class="bg-green-500 text-black dark:text-white px-4 py-2 rounded mt-4">Guardar Venta</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const detallesBody = document.getElementById('detallesBody');
    const agregarProductoBtn = document.getElementById('agregarProducto');
    const totalVentaSpan = document.getElementById('totalVenta');
    const totalInput = document.getElementById('totalInput');
    
    const ventaForm = document.getElementById('ventaForm');
    let rowCount = detallesBody.querySelectorAll('tr').length;

    function actualizarPrecio(event) {
        const fila = event.target.closest('tr');
        const precioTd = fila.querySelector('.precio');
        const precio = event.target.options[event.target.selectedIndex].dataset.precio;
        precioTd.textContent = parseFloat(precio).toFixed(2);
        actualizarSubtotal({target: fila.querySelector('input[name="cantidad[]"]')});
    }

    function actualizarSubtotal(event) {
        const fila = event.target.closest('tr');
        const precio = parseFloat(fila.querySelector('.precio').textContent);
        const cantidad = parseInt(event.target.value);
        const subtotalTd = fila.querySelector('.subtotal');
        const subtotal = precio * cantidad;
        subtotalTd.textContent = subtotal.toFixed(2);
        actualizarTotal();
    }

    function eliminarFila(event) {
        const fila = event.target.closest('tr');
        fila.remove();
        rowCount--;
        actualizarTotal();
    }

    function actualizarTotal() {
        const subtotales = document.querySelectorAll('.subtotal');
        let total = 0;
        subtotales.forEach(subtotal => {
            total += parseFloat(subtotal.textContent);
        });
        total = 1.18 * total; // Considerando IGV
        totalVentaSpan.textContent = total.toFixed(2);
        totalInput.value = total.toFixed(2);
    }

    agregarProductoBtn.addEventListener('click', function() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="border p-2 text-center">
                <select name="id_producto[]" class="w-full">
                    <option value="">Seleccione un producto</option>
                    {% for producto in productos %}
                    <option value="{{ producto.id }}" data-precio="{{ producto.precio }}">{{ producto.descripcion }}</option>
                    {% endfor %}
                </select>
            </td>
            <td class="border p-2 text-center"><input type="number" name="cantidad[]" value="1" min="1" class="text-center w-full"></td>
            <td class="border p-2 text-center precio">0.00</td>
            <td class="border p-2 text-center subtotal">0.00</td>
            <td class="border p-2 text-center"><button type="button" class="eliminarFila bg-red-500 text-black dark:text-white px-2 py-1 rounded">Eliminar</button></td>
        `;
        detallesBody.appendChild(newRow);
        rowCount++;
        actualizarEventListeners();
        actualizarTotal();
    });

    function actualizarEventListeners() {
        const filas = detallesBody.querySelectorAll('tr');
        filas.forEach(fila => {
            const productoSelect = fila.querySelector('select[name="id_producto[]"]');
            const cantidadInput = fila.querySelector('input[name="cantidad[]"]');
            const eliminarBtn = fila.querySelector('.eliminarFila');

            productoSelect.addEventListener('change', actualizarPrecio);
            cantidadInput.addEventListener('input', actualizarSubtotal);
            eliminarBtn.addEventListener('click', eliminarFila);
        });
    }

    actualizarEventListeners();

    ventaForm.addEventListener('submit', function(event) {
        if (rowCount === 0) {
            event.preventDefault();
            alert('Debe agregar al menos un producto a la venta.');
        }
    });
});
</script>
{% endblock %}
